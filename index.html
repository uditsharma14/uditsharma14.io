<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>COVID-19 USA Cases: Narrative Visualization</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <!-- Load d3-annotation -->
        <script
            src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
        <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      text-align: center;
    }
    #controls {
      margin-bottom: 10px;
    }
    button {
      padding: 6px 12px;
      font-size: 14px;
    }
    svg {
      background: #fff;
      border: 1px solid #ddd;
      display: inline-block;
    }
    .tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.1s;
    }
  </style>
    </head>
    <body>

        <h1>COVID-19 Daily New Cases in the USA</h1>
        <div id="controls">
            <button id="prev" disabled>← Prev</button>
            <button id="next">Next →</button>
        </div>
        <div style="position: relative; display: inline-block;">
            <svg id="chart" width="900" height="500"></svg>
            <div class="tooltip" id="tooltip"></div>
        </div>

        <script>
  // --- Globals & State ---
  const svg       = d3.select("#chart"),
        margin    = { top: 50, right: 20, bottom: 80, left: 100 },
        width     = +svg.attr("width")  - margin.left - margin.right,
        height    = +svg.attr("height") - margin.top  - margin.bottom,
        container = svg.append("g")
                       .attr("transform", `translate(${margin.left},${margin.top})`);

  let fullData = [],                  // will hold { date: Date, cases: Number }[]
      xScale, yScale,                // base scales
      currentScene = 0,
      scenes;

  const tooltip = d3.select("#tooltip");

  const dataUrl = 'https://uditsharma14.github.io/uditsharma14.io/data/owid-covid-data_final_2023_1.csv';


  // --- Load & Parse Data ---
  const parseDate = d3.timeParse("%Y-%m-%d");
  d3.csv(dataUrl,
    d => d.iso_code === "USA" 
         ? { date: parseDate(d.date), cases: +d.new_cases } 
         : null
  ).then(raw => {
    fullData = raw.filter(d => d).sort((a,b) => a.date - b.date);
    
    // define base scales
    xScale = d3.scaleTime()
               .range([0, width])
               .domain(d3.extent(fullData, d => d.date));
    yScale = d3.scaleLinear()
               .range([height, 0])
               .domain([0, d3.max(fullData, d => d.cases)]);
    
    // define scenes
    scenes = [ renderOverview, renderFirstWave, renderOmicron ];
    // wire buttons
    d3.select("#prev").on("click", () => changeScene(-1));
    d3.select("#next").on("click", () => changeScene( 1));
    // initial render
    renderScene();
  });

  // --- Scene Control ---
  function changeScene(delta) {
    currentScene = Math.max(0, Math.min(scenes.length - 1, currentScene + delta));
    d3.select("#prev").property("disabled", currentScene === 0);
    d3.select("#next").property("disabled", currentScene === scenes.length - 1);
    renderScene();
  }

  function renderScene() {
    container.selectAll("*").remove();
    scenes[currentScene]();
  }

  // --- Shared Drawing Helpers ---
  function drawAxes(x, y) {
    container.append("g")
      .call(d3.axisLeft(y).tickFormat(d3.format(",")));
    container.append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b %Y")))
      .selectAll("text")
        .attr("text-anchor", "end")
        .attr("transform", "rotate(-40) translate(-5,0)");
    // Axis titles
    svg.selectAll(".axis-title").remove();
    svg.append("text")
      .attr("class", "axis-title")
      .attr("x", margin.left + width/2)
      .attr("y", margin.top + height + 60)
      .attr("text-anchor", "middle")
      .text("Date (Month Year)");
    svg.append("text")
      .attr("class", "axis-title")
      .attr("transform", 
            `translate(${margin.left - 60},${margin.top + height/2}) rotate(-90)`)
      .attr("text-anchor", "middle")
      .text("Daily New COVID-19 Cases");
  }

  function drawBars(data, x, y) {
      container.selectAll("rect")
        .data(data)
        .join("rect")
        .attr("x", d => x(d.date) - 1)
        .attr("y", d => y(d.cases))
        .attr("width", 2)
        .attr("height", d => height - y(d.cases))
        .attr("fill", "red")                    // ← add this
        .on("mouseover", function (event, d) {
          const [mx, my] = d3.pointer(event, document.body);
          tooltip.style("opacity", 1)
            .html(`<strong>${d3.timeFormat("%b %d, %Y")(d.date)}</strong><br/>${d3.format(",")(d.cases)} cases`)
            .style("left", (mx + 10) + "px")
            .style("top", (my - 30) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));
    }

  // --- Scene Definitions ---
  function renderOverview() {
    drawAxes(xScale, yScale);
    drawBars(fullData, xScale, yScale);
    const x1 = xScale.copy().domain([ parseDate("2020-03-01"), parseDate("2021-01-31") ]);
    const ann = d3.annotation()
      .annotations([{
        note: { title: "Covid Cases Overview ", label: "SARS Covid-19 2020-2023" },
        x: x1(parseDate("2020-07-15")),
        y: yScale(4500_000),
        dx: 0, dy: -40
      }]);

    container.append("g")
      .attr("class", "annotation-group")
      .call(ann);

  }

  function renderFirstWave() {
    const x1 = xScale.copy().domain([ parseDate("2020-03-01"), parseDate("2021-01-31") ]);
    drawAxes(x1, yScale);
    drawBars(fullData.filter(d => d.date >= x1.domain()[0] && d.date <= x1.domain()[1]), x1, yScale);

    const ann = d3.annotation()
      .annotations([{
        note: { title: "Covid First Wave,Daily ~70K cases", label: "July 2020 Peak" },
        x: x1(parseDate("2020-07-15")),
        y: yScale(70_000),
        dx:   0, dy: -40
      }]);
    container.append("g").call(ann);
  }

  function renderOmicron() {
    const x2 = xScale.copy().domain([ parseDate("2021-11-01"), parseDate("2022-03-31") ]);
    drawAxes(x2, yScale);
    drawBars(fullData.filter(d => d.date >= x2.domain()[0] && d.date <= x2.domain()[1]), x2, yScale);

    const ann = d3.annotation()
      .annotations([
        {
          note: { title: "Rapid Surge", label: "Nov–Dec 2021" },
          x: x2(parseDate("2021-12-01")),
          y: yScale(1_000_000),
          dx: -20, dy: -40
        },
        {
          note: { title: "Omicron Wave", label: "Nov 2021 – Feb 2022" },
          x: x2(parseDate("2022-02-01")),
          y: yScale(4500_000),
          dx: -20, dy: -40
        },
        {
          note: { title: "Decline", label: "Feb–Mar 2022" },
          x: x2(parseDate("2022-02-15")),
          y: yScale(1_200_000),
          dx: +30, dy: +30
        }
      ]);
    container.append("g").call(ann);
  }
  </script>
    </body>
</html>
